<!DOCTYPE html>
<html lang="en-us">

  <head>
  <!-- <link href="https://gmpg.org/xfn/11" rel="profile"> -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/fonts/abril_pt.css">
  <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> -->

  <!-- CMU Fonts -->
  <style type="text/css">
    @font-face {
      font-family: "Computer Modern";
      src: url('/public/fonts/cmunss.otf');
    }
    @font-face {
      font-family: "Computer Modern";
      src: url('/public/fonts/cmunsx.otf');
      font-weight: bold;
    }
    @font-face {
      font-family: "Computer Modern";
      src: url('/public/fonts/cmunsi.otf');
      font-style: italic, oblique;
    }
    @font-face {
      font-family: "Computer Modern";
      src: url('/public/fonts/cmunbxo.otf');
      font-weight: bold;
      font-style: italic, oblique;
    }
    @font-face {
      font-family: "Classical Computer Modern";
      src: url('/public/fonts/cmunci.otf');
      /* font-style: italic, oblique; */
    }
  </style>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- MathJax -->
  <!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML'></script> -->
  <!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML'></script> -->
  <!-- <script type="text/x-mathjax-config">
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"],
        bcancel: ["Extension","cancel"],
        xcancel: ["Extension","cancel"],
        cancelto: ["Extension","cancel"]
      });
    });
  </script> -->

  <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- jQuery -->
  <script src="/public/js/jquery.js"></script>

  <!-- TOC -->
  <script src="/public/js/toc.js"></script>

  <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Coding Serverless Functions in Idris | Donald Pinckney</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Coding Serverless Functions in Idris" />
<meta name="author" content="Donald Pinckney" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Brief Intro to Serverless Computing" />
<meta property="og:description" content="Brief Intro to Serverless Computing" />
<link rel="canonical" href="https://donaldpinckney.com/idris/2019/03/26/idris-serverless.html" />
<meta property="og:url" content="https://donaldpinckney.com/idris/2019/03/26/idris-serverless.html" />
<meta property="og:site_name" content="Donald Pinckney" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-26T00:00:00-07:00" />
<script type="application/ld+json">
{"description":"Brief Intro to Serverless Computing","author":{"@type":"Person","name":"Donald Pinckney"},"@type":"BlogPosting","url":"https://donaldpinckney.com/idris/2019/03/26/idris-serverless.html","headline":"Coding Serverless Functions in Idris","dateModified":"2019-03-26T00:00:00-07:00","datePublished":"2019-03-26T00:00:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://donaldpinckney.com/idris/2019/03/26/idris-serverless.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body class="theme-base-0b">

    <div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Donald Pinckney
        </a>
      </h1>
      <p class="lead">1st year programming languages PhD student at UMass Amherst.</p>
    </div>

    <nav class="sidebar-nav">
      <div class="horizontal-block">
        <div class="horizontal-item">
        </div>
        
        

        <a class="horizontal-item sidebar-nav-item" href="/">Home</a>

        

        
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
              <a class="horizontal-item sidebar-nav-item " href="/publications.html">Publications</a>
            
          
        
          
            
          
        
          
            
          
        
          
        
          
            
          
        
          
        
          
        

        <a class="horizontal-item sidebar-nav-item active" href="/blog/">Blog Posts</a>

        <a class="horizontal-item sidebar-nav-item" href="/books/tensorflow/book/">TensorFlow Guide</a>

        <div class="horizontal-item">
        </div>
      </div>

      <hr />

      <div class="horizontal-block">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        


        <a href="https://github.com/donald-pinckney" class="sidebar-nav-item horizontal-item social" target="_blank">
          <i class="fa fa-github"></i><span class="only-desktop"> donald-pinckney</span>
        </a>
        <a href="https://twitter.com/donald_pinckney" class="sidebar-nav-item horizontal-item social" target="_blank">
          <i class="fa fa-twitter"></i><span class="only-desktop">@donald_pinckney</span>
        </a>
        <a href="mailto:dpinckney@cs.umass.edu" class="sidebar-nav-item horizontal-item social" target="_blank">
          <i class="fa fa-envelope"></i>&nbsp;<span class="only-desktop">dpinckney@cs.umass.edu</span>
        </a>
        <a href="/public/files/documents/resume.pdf" class="sidebar-nav-item horizontal-item social" target="_blank">
            <i class="fa fa-file"></i>&nbsp;<span>Curriculum vitae</span>
        </a>

      </div>
    </nav>

    <div class="sidebar-footnote">
      <p class="sidebar-footnote">
        &copy; 2019 Donald Pinckney. All rights reserved.
        <!-- <br />
        The views and opinions expressed here are my own, and do not reflect the views of Apple, Inc. -->
      </p>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="post">

  
    <h1 class="post-title titular">Coding Serverless Functions in Idris</h1>
  
  
    <div class="floating-box-right">
      


      
    </div> 

  <span class="post-date">26 Mar 2019. Categories: 
  <!-- <div class="post-categories"> -->
  
  
  <a href="/categories/#Idris">Idris</a>
  
  
<!-- </div> -->

</span>



<div id="toc"></div>
<script type="text/javascript">
  $(document).ready(function() {
    // alert("READY");
      $('#toc').toc();
  });
</script>


<h1 id="brief-intro-to-serverless-computing">Brief Intro to Serverless Computing</h1>

<p>Serverless computing platforms such as <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> and <a href="https://cloud.google.com/functions/">Google Cloud Functions</a> have recently become a hot trend for writing backend code. With serverless computing we don’t need to setup, configure and maintain servers ourselves as it is handled automatically by the platform. Likewise, the platform will also automatically scale our code to more instances as needed, saving us both money and development time.</p>

<p>The fundamental abstraction of serverless computing are <em>serverless functions</em>, which is a piece of code that receives as input an HTTP request, and produces as output an HTTP response. If this is new to you, <a href="https://medium.com/@BoweiHan/an-introduction-to-serverless-and-faas-functions-as-a-service-fb5cec0417b2">check out this post</a>. Most commonly these serverless functions are written in JavaScript or Python, the architecture of serverless functions make functional programming languages such as <a href="https://www.haskell.org">Haskell</a> a really nice fit. With Haskell we can get some good guarantees about our code due to its quite powerful type system. However, since we often house critical business logic inside these serverless functions, it would be great if we can get absolute assurance that our code is correct. For this reason I think that dependently-typed programming languages, in particular <a href="https://www.idris-lang.org">Idris</a>, are really interesting and promising languages for writing serverless functions.</p>

<h1 id="writing-serverless-functions-in-idris">Writing Serverless Functions in Idris</h1>

<p>In this post I want to walk through how we can write serverless functions in Idris and deploy them to Google Cloud. To do so, you need to make sure you have the necessary toolchains installed.</p>

<h2 id="installing-stuff">Installing Stuff</h2>

<p>First, Idris needs to be installed (see <a href="https://www.idris-lang.org/download/">here</a> for more info). Assuming you already have Haskell and <code class="highlighter-rouge">cabal</code> installed, it should be as easy as:</p>

<pre><code class="language-idris">cabal update
cabal install idris
</code></pre>

<p>In addition, for writing Idris code I highly recommend using the <a href="https://atom.io">Atom editor</a> since Atom has a great Idris package <code class="highlighter-rouge">language-idris</code>.</p>

<p>Since this tutorial specifically shows how to deploy to Google Cloud Functions, you need to make sure to have the Google Cloud SDK command line tools installed if you want to follow along directly. On the other hand, the techniques shown below will probably work just as well with AWS Lambda if you would rather use that, I just won’t give specific instructions since I haven’t tried it yet. If you want to setup Google Cloud Functions SDK, you can <a href="https://cloud.google.com/functions/">get started here</a>.</p>

<h2 id="writing-a-function-in-idris">Writing a Function in Idris</h2>

<p>In this post we won’t be looking at using Idris to prove correctness of code, just how to get any code at all to run on Google Cloud Functions. We can start out by writing a simple hello world function in Idris by making a new file <code class="highlighter-rouge">function.idr</code> and putting in the following:</p>

<pre><code class="language-idris">module MyFunction

hello : String -&gt; String
hello req = "Hello: " ++ req
</code></pre>

<p>All that this function does is take as input a string (<code class="highlighter-rouge">req</code>), and concatenate at the beginning <code class="highlighter-rouge">"Hello: "</code>. You can test that this works by opening the Idris REPL with this file in your terminal, and calling the function:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>idris <span class="k">function</span>.idr
     ____    __     _
    /  _/___/ /____<span class="o">(</span>_<span class="o">)</span>____
    / // __  / ___/ / ___/     Version 1.3.1-git:268db5dc2
  _/ // /_/ / /  / <span class="o">(</span>__  <span class="o">)</span>      http://www.idris-lang.org/
 /___/<span class="se">\_</span>_,_/_/  /_/____/       Type :? <span class="k">for </span><span class="nb">help

</span>Idris is free software with ABSOLUTELY NO WARRANTY.
For details <span class="nb">type</span> :warranty.
<span class="k">*function</span><span class="o">&gt;</span> hello <span class="s2">"Nancy"</span>
<span class="s2">"Hello: Nancy"</span> : String
<span class="k">*function</span><span class="o">&gt;</span>
</code></pre></div></div>

<h2 id="exporting-the-function-to-javascript">Exporting the Function to JavaScript</h2>

<p>This is great, but we need a way to run this code on Google Cloud Functions. Fortunately, Idris provides a built-in compiler to JavaScript, so we can compile our Idris function above into JavaScript code, which Google Cloud Functions directly supports. However, we still need a way to access the incomming HTTP request object, and write a string to the response. Since both the request and response are actual JavaScript objects, the most convenient thing to do is write some wrapper JavaScript which calls our <code class="highlighter-rouge">hello</code> function.</p>

<p>But to do this we need to make sure that JavaScript code can call our <code class="highlighter-rouge">hello</code> function. To do this we just need to add an <code class="highlighter-rouge">FFI_Export</code> declaration to the Idris code:</p>

<pre><code class="language-idris">module MyFunction

export -- This is new
hello : String -&gt; String
hello req = "Hello: " ++ req

-- This is all new
lib : FFI_Export FFI_JS "" []
lib =
    Fun hello "hello" $
    End
</code></pre>

<p>At this point it’s a good idea to test that the compilation and exporting to JavaScript actually works. In your terminal first compile the function to JavaScript:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>idris <span class="nt">--codegen</span> node <span class="nt">--interface</span> <span class="k">function</span>.idr <span class="nt">-o</span> <span class="k">function</span>.js
</code></pre></div></div>

<p>The <code class="highlighter-rouge">--codegen node</code> options tells Idris to compile it to JavaScript rather than a binary, and the <code class="highlighter-rouge">--interface</code> options tells Idris to create a node module with exports rather than a standalone executable script. If this compiles without problems, you can try loading the result in node and calling your <code class="highlighter-rouge">hello</code> function from JavaScript. Assuming you have <code class="highlighter-rouge">node</code> installed, you can try:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node
<span class="o">&gt;</span> f <span class="o">=</span> require<span class="o">(</span><span class="s1">'./function.js'</span><span class="o">)</span>
<span class="o">{</span> hello: <span class="o">[</span>Function: MyFunction__hello] <span class="o">}</span>
<span class="o">&gt;</span> f.hello<span class="o">(</span><span class="s2">"Larry"</span><span class="o">)</span>
<span class="s1">'Hello: Larry'</span>
<span class="o">&gt;</span>
</code></pre></div></div>

<h2 id="putting-the-pieces-together">Putting the Pieces Together</h2>

<p>At this point we have a function written in Idris, which we can call from JavaScript. All that we need to do is write a simple JavaScript wrapper which will be the main entry point of the serverless function, and which will call the Idris <code class="highlighter-rouge">hello</code> function. Make a new file <code class="highlighter-rouge">index.js</code> with this code:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./function.js'</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">gcf_main</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">gcf_main</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">hello</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This code first loads <code class="highlighter-rouge">function.js</code> which is the compiled version of our Idris code <code class="highlighter-rouge">function.idr</code>, and then defines <code class="highlighter-rouge">gcf_main</code> which is the main entry point of our serverless function. All this does is extract the HTTP request body as a string, call the <code class="highlighter-rouge">hello</code> function, and send the result in the HTTP response body. There should probably be some checking for existence and content type of the body, but this suffices for a demo example.</p>

<p>This is all the code we need to write! You can deploy this to Google Cloud Functions with the command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud functions deploy my-function-name <span class="nt">--entry-point</span> gcf_main <span class="nt">--runtime</span> nodejs6 <span class="nt">--trigger-http</span>
</code></pre></div></div>

<p>You can put whatever you want for <code class="highlighter-rouge">my-function-name</code>.</p>

<p>Once it finishes deploying it should report an <code class="highlighter-rouge">httpsTrigger</code> URL, something like:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>httpsTrigger:
  url: https://MY-DOMAIN.cloudfunctions.net/my-function-name
</code></pre></div></div>

<p>At this point you can send an actual HTTP request and get a response by using <code class="highlighter-rouge">curl</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-X</span> POST https://MY-DOMAIN.cloudfunctions.net/my-function-name <span class="nt">-H</span> <span class="s2">"Content-Type:text/plain"</span>  <span class="nt">-d</span> <span class="s1">'Suzie'</span>
Hello: Suzie
</code></pre></div></div>

<p>This shows that our compiled Idris code was actually successfully executed on Google’s servers. Pretty cool!</p>

<h1 id="whats-next">What’s Next</h1>

<p>While easy to setup, the approach here does have a few problems. Most importantly, the Idris function doesn’t have very much control over accessing the HTTP request and response. For example, the Idris function has no way to return an HTTP status code other than 200, nor does it have a way to return content types other than plain text. In addition, the Idris function can’t branch on different request content types or other HTTP headers.</p>

<p>To improve this we can try and put more logic into the JavaScript code wrapper. However, the purpose of using Idris is to be able to verify correctness of our code, so the more code we move into the JavaScript, the more code we aren’t able to prove correctness of. A different approach is to write everything in Idris, discard the JavaScript wrapper, and use Idris’s JavaScript FFI to access the request and response objects directly. This approach is a lot more involved to setup, and unfortunately <a href="https://github.com/idris-lang/Idris-dev/issues/4656">currently triggers a bug in the compiler</a>. However, as this bug is worked out and libraries are developed to make accessing the request and response objects more convenient, I think this approach will become more promising.</p>

<p>At the present, Idris provides a convenient way to write serverless functions in a dependently-typed language, giving you the ability to prove correctness of critical business logic. If you need to do a lot of manipulation of HTTP request and response objects then Idris might not be quite ready yet, but hopefully will be down the road. If you are a lighter user of HTTP APIs, then I suggest giving Idris a try, it’s quite fun!</p>

</div>



<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/tensorflow/2018/11/15/feature-scaling.html" class="titular">
            Feature Scaling
            <small>15 Nov 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/metal/2018/07/27/metal-intro-2.html" class="titular">
            Metal 3D Graphics Part 2: Animated Uniform Data with Synchronization
            <small>27 Jul 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/metal/2018/07/05/metal-intro-1.html" class="titular">
            Metal 3D Graphics Part 1: Basic Rendering
            <small>05 Jul 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
